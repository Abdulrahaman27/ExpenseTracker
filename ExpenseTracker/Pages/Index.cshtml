@page
@model ExpenseTracker.Pages.IndexModel

    <div class="container">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Total Income</h5>
                        <h2 class="card-text">
                            @if (Model.DashboardStats != null)
                            {
                                @Model.DashboardStats.TotalIncome.ToString("C")
                            }
                            else
                            {
                                @: $0.00
                            }
                        </h2>
                        <small><i class="bi bi-arrow-up-circle"></i> All time</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">Total Expenses</h5>
                        <h2 class="card-text">
                            @if (Model.DashboardStats != null)
                            {
                                @Model.DashboardStats.TotalExpenses.ToString("C")
                            }
                            else
                            {
                                @: $0.00
                            }
                        </h2>
                        <small><i class="bi bi-arrow-down-circle"></i> All time</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Balance</h5>
                        <h2 class="card-text">
                            @if (Model.DashboardStats != null)
                            {
                                @Model.DashboardStats.Balance.ToString("C")
                            }
                            else
                            {
                                @: $0.00
                            }
                        </h2>
                        <small><i class="bi bi-wallet2"></i> Net</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Transactions</h5>
                        <h2 class="card-text">
                            @if (Model.RecentTransactions != null)
                            {
                                @Model.RecentTransactions.Count
                            }
                            else
                            {
                                @: 0
                            }
                        </h2>
                        <small><i class="bi bi-receipt"></i> Total</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="/Transactions/Create" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Add Transaction
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/Budgets/Create" class="btn btn-primary w-100">
                            <i class="bi bi-pie-chart"></i> Create Budget
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/Categories/Index" class="btn btn-info w-100">
                            <i class="bi bi-tags"></i> Manage Categories
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/Reports/Index" class="btn btn-warning w-100">
                            <i class="bi bi-bar-chart"></i> View Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Recent Transactions -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.RecentTransactions != null && Model.RecentTransactions.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var transaction in Model.RecentTransactions)
                                        {
                                            <tr>
                                                <td>@transaction.Date.ToString("MMM dd")</td>
                                                <td>@transaction.Description</td>
                                                <td>
                                                    @if (transaction.Category != null)
                                                    {
                                                        <span class="badge" style="background-color: @transaction.Category.Color">
                                                            @transaction.Category.Name
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Uncategorized</span>
                                                    }
                                                </td>
                                                <td class="text-end @(transaction.Type == ExpenseTracker.Data.Models.TransactionType.Income ? "text-success" : "text-danger")">
                                                    @(transaction.Type == ExpenseTracker.Data.Models.TransactionType.Income ? "+" : "-")@transaction.Amount.ToString("C")
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <a href="/Transactions" class="btn btn-outline-primary">View All Transactions</a>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-receipt fa-3x mb-3"></i>
                                <p>No transactions yet.</p>
                                <a href="/Transactions/Create" class="btn btn-success">
                                    <i class="bi bi-plus-circle"></i> Add Your First Transaction
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Category Summary -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Top Categories</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.DashboardStats?.CategorySpendings != null && Model.DashboardStats.CategorySpendings.Any())
                        {
                            <canvas id="categoryChart" height="250"></canvas>
                            <div class="mt-3">
                                @foreach (var category in Model.DashboardStats.CategorySpendings.Take(3))
                                {
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>@category.CategoryName</span>
                                            <span>@category.Amount.ToString("C")</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar"
                                                 style="width: @category.Percentage%; background-color: @category.CategoryColor">
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-pie-chart fa-3x mb-3"></i>
                                <p>No expense data yet.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Add Button -->
    <div style="position: fixed; bottom: 30px; right: 30px;">
        <a href="/Transactions/Create" class="btn btn-success btn-lg rounded-circle shadow-lg"
           style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-plus-lg"></i>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    @if (Model.DashboardStats?.CategorySpendings != null && Model.DashboardStats.CategorySpendings.Any())
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var ctx = document.getElementById('categoryChart').getContext('2d');

                // Use explicit arrays to avoid null issues
                var labels = [
            @Html.Raw(string.Join(",", Model.DashboardStats.CategorySpendings.Select(c => $"'{c.CategoryName}'")))
                ];

                var dataValues = [
            @string.Join(",", Model.DashboardStats.CategorySpendings.Select(c => c.Amount))
                ];

                var backgroundColors = [
            @Html.Raw(string.Join(",", Model.DashboardStats.CategorySpendings.Select(c => $"'{c.CategoryColor}'")))
                ];

                var data = {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                };

                new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            });
        </script>
    }
